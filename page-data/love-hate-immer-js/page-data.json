{"componentChunkName":"component---src-templates-blog-post-js","path":"/love-hate-immer-js/","result":{"data":{"site":{"siteMetadata":{"title":"scraggo.com"}},"markdownRemark":{"id":"ba53b4c7-a95a-50a3-97c0-91074700f912","excerpt":"After having used immutable js for a while, discovering immer js was a breath of fresh air. Where immutable js forces you to learn its gigantic API, immer js…","html":"<p>After having used <a href=\"https://immutable-js.github.io/immutable-js/docs/#/\">immutable js</a> for a while, discovering <a href=\"https://immerjs.github.io/immer/docs/introduction\">immer js</a> was a breath of fresh air. Where immutable js forces you to learn its gigantic API, immer js takes advantage of <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy\">ES6 Proxies</a>. These allow you to modify a “draft” version of an object as if you’re mutating it, but <em>the draft is actually a copy</em> so you’re not mutating the original! The return of immer’s <code class=\"language-text\">produce</code> function always returns a perfect clone of the draft. <code class=\"language-text\">Immer js</code> also touts:</p>\n<blockquote>\n<p>Winner of the “Breakthrough of the year” React open source award and “Most impactful contribution” JavaScript open source award in 2019.</p>\n<p>Benefits</p>\n<ul>\n<li>Immutability with normal JavaScript objects, arrays, Sets and Maps. No new APIs to learn!</li>\n<li>Strongly typed, no string based paths selectors etc.</li>\n<li>Structural sharing out of the box</li>\n<li>Object freezing out of the box</li>\n<li>Deep updates are a breeze</li>\n<li>Boilerplate reduction. Less noise, more concise code.</li>\n<li>First class support for patches</li>\n<li>Small: 3KB gzipped</li>\n</ul>\n</blockquote>\n<h2>Quick Example of Immer in Action</h2>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// the main export of immer is the majority of what you need to know:</span>\n<span class=\"token keyword\">import</span> produce <span class=\"token keyword\">from</span> <span class=\"token string\">'immer'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> baseState <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    todo<span class=\"token operator\">:</span> <span class=\"token string\">'Learn typescript'</span><span class=\"token punctuation\">,</span>\n    done<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    todo<span class=\"token operator\">:</span> <span class=\"token string\">'Try immer'</span><span class=\"token punctuation\">,</span>\n    done<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// we use .push and direct assignment to modify the draftState.</span>\n<span class=\"token comment\">// we don't even need to return the draftState. The return is implied!</span>\n<span class=\"token keyword\">const</span> nextState <span class=\"token operator\">=</span> <span class=\"token function\">produce</span><span class=\"token punctuation\">(</span>baseState<span class=\"token punctuation\">,</span> <span class=\"token parameter\">draftState</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  draftState<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> todo<span class=\"token operator\">:</span> <span class=\"token string\">'Tweet about it'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  draftState<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>done <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>I was <em>so</em> excited when I first read about this library. I found an excuse to use it in a big collaborative side-project. It’s a react app that makes heavy use of redux. As we know with both react and redux, one must treat state immutably. <code class=\"language-text\">Immer js</code> handles this exact problem and I don’t need to convert the project to the mentality of <code class=\"language-text\">immutable js</code>, use <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax\">spread re-assignment</a>, or <a href=\"https://lodash.com/docs#cloneDeep\"><code class=\"language-text\">lodash</code> cloneDeep</a>.</p>\n<h2>How Immer falls short</h2>\n<p>While <code class=\"language-text\">immer js</code> touts being simple and intuitive to use, it has a significant learning curve. It has a <a href=\"https://immerjs.github.io/immer/docs/pitfalls\">decent-sized list of pitfalls</a> which makes me a bit suspicious about its usability in a big project.</p>\n<p>Here are a few examples of the shortcomings I’ve ran into:</p>\n<h3>Error: An immer producer returned a new value <em>and</em> modified its draft. Either return a new value <em>or</em> modify the draft</h3>\n<p><code class=\"language-text\">Immer js</code> messes with my flow in Redux reducers. I have to be vigilant about where the draft is modified and where I want to return a new object. The error above provides a stack trace that doesn’t point to the problem - it merely points to where the <code class=\"language-text\">produce</code> function containing the culprit is defined:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/af86c48c836b7602f6cbfc1302489ff0/28283/immer-error.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.14080164439877%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA4ElEQVQY032Q2XbCMAxE89hCCPFaxWuaUP7/DwdJLRwecvow3iRfj2dw8YLSImoLSMUh1YCleFB2Omc+X3hN2fLevWrSJ8p8V3pKjxDWYP0IKgFuJVgBfxNaD7jdK/Z7w/5T0bcF657QpMaiPMPHSQHvmt2Jge7MmwlGHFWPVg1yMeid3VWHuMwIdNUeG0aV8Sdc7eehBuPP+tqFwZGdZobS39epWAaN/GUL6ZvMx+uiuDnSIMMzK9FvLs+115pk+JWMunuHHYEV2LeE7VY0r40ls+S37lnP1S1DxeV/7kQPpteVrr0SSdUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"immer-error.png\"\n        title=\"immer-error.png\"\n        src=\"/static/af86c48c836b7602f6cbfc1302489ff0/799d3/immer-error.png\"\n        srcset=\"/static/af86c48c836b7602f6cbfc1302489ff0/00d96/immer-error.png 148w,\n/static/af86c48c836b7602f6cbfc1302489ff0/0b23c/immer-error.png 295w,\n/static/af86c48c836b7602f6cbfc1302489ff0/799d3/immer-error.png 590w,\n/static/af86c48c836b7602f6cbfc1302489ff0/2a3d6/immer-error.png 885w,\n/static/af86c48c836b7602f6cbfc1302489ff0/ae92f/immer-error.png 1180w,\n/static/af86c48c836b7602f6cbfc1302489ff0/28283/immer-error.png 1946w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>To fix this particular error, I had to move one of the <code class=\"language-text\">case</code> declarations to before where I modify the draft. Before:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">draft<span class=\"token punctuation\">.</span>error <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">case</span> <span class=\"token constant\">LOGOUT</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">return</span> initialState<span class=\"token punctuation\">;</span></code></pre></div>\n<p>After:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// immer doesn't let you return a new state after draft is modified.</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">LOGOUT</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> initialState<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\ndraft<span class=\"token punctuation\">.</span>error <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">case</span> <span class=\"token constant\">LOGIN</span><span class=\"token operator\">:</span>\n    <span class=\"token comment\">// etc...</span></code></pre></div>\n<p>We can see that after I modify the draft, it’s <em>literally</em> a point of no-return. We are forced to return the draft and not a new object. This is a buzz-kill, for sure.</p>\n<h3>Spread assignment workaround</h3>\n<p>I’ve found ES6 spread re-assignment to be extremely cool:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">case</span> <span class=\"token constant\">LOGIN_SUCCESS</span><span class=\"token operator\">:</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>state<span class=\"token punctuation\">,</span>\n    <span class=\"token operator\">...</span>data<span class=\"token punctuation\">.</span>parsed<span class=\"token punctuation\">,</span> <span class=\"token comment\">// this spreads all the properties received from `parsed` into new state</span>\n    firebaseData<span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>firebaseData<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>However, as we saw above, we have to continue to modify state to stay in the <code class=\"language-text\">immer js</code> mentality, so we need a workaround. At first, I came up with something that feels “old-school” (not in a good way):</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">/**\n * Immer helper, akin to spread assignment:\n * @example Instead of { ...obj }, it will be spreadAssign(draft, obj)\n * @param {Object} draft\n * @param {Object} obj\n * @returns {Object} draft modified\n */</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">spreadAssign</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">draft<span class=\"token punctuation\">,</span> obj</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">entries</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">]</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// eslint-disable-next-line no-param-reassign</span>\n    draft<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> v<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> draft<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// ...</span>\n\n<span class=\"token comment\">// Reducer</span>\n\n<span class=\"token keyword\">case</span> <span class=\"token constant\">LOGIN_SUCCESS</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  draft<span class=\"token punctuation\">.</span>firebaseData <span class=\"token operator\">=</span> firebaseData<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">spreadAssign</span><span class=\"token punctuation\">(</span>draft<span class=\"token punctuation\">,</span> parsed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> draft<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Writing helper functions for <code class=\"language-text\">immer js</code> seems backwards to me. Then…I remembered good old <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign\">Object.assign()</a> which modifies the object passed in as the first argument. I can now change the above to:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Reducer</span>\n<span class=\"token keyword\">case</span> <span class=\"token constant\">LOGIN_SUCCESS</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  draft<span class=\"token punctuation\">.</span>firebaseData <span class=\"token operator\">=</span> firebaseData<span class=\"token punctuation\">;</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span>draft<span class=\"token punctuation\">,</span> parsed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> draft<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Thankfully, I can delete my <code class=\"language-text\">spreadAssign</code> function which winds up being a subset of <code class=\"language-text\">Object.assign</code>.</p>\n<h2>Conclusion</h2>\n<p>Be warned: finding workarounds (that aren’t documented) and getting errors related to modifying drafts bring the learning curve of <code class=\"language-text\">immer js</code> up. I’m not going to peel <code class=\"language-text\">immer js</code> out of the codebase I’m working on just yet, but I expect to discover more headaches while continuing to use it. I love <code class=\"language-text\">immer js</code> when it simplifies things, but hate it when it gets in the way.</p>\n<p><em>Have any thoughts on using immer? Please share them with me!</em></p>\n<p><a href=\"/contact\">Contact me</a></p>","fields":{"slug":"/love-hate-immer-js/"},"frontmatter":{"author":"Dave Cohen","categories":["tech"],"date":"August 21, 2020","description":null,"tags":["ImmerJS","JavaScript","react","redux"],"title":"My love hate relationship with ImmerJS"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/love-hate-immer-js/","previous":{"fields":{"slug":"/tech-talk-improving-capstone-project/"},"frontmatter":{"title":"Tech Talk - How I'd Improve My Capstone Project","type":"post"}},"next":null}}}